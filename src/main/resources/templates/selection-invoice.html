<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Saýlamak</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            background-color: #f0f8ff;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .add-drug-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #28a745;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 16px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
}
        .container {
            display: flex;
            gap: 20px;
        }
        .box {
            min-width: 300px;
            min-height: 300px;
            border: 2px dashed #ccc;
            padding: 10px;
            padding-bottom:50px;
            background-color: #f9f9f9;
        }
        .item {
            padding: 8px;
            margin: 5px;
            background-color: #4CAF50;
            min-width:300px;
            color: white;
            cursor: grab;
            display: flex;
            justify-content: space-between;
        }
        .delete-btn {
            background: red;
            border: none;
            color: white;
            cursor: pointer;
            padding: 2px 5px;
        }
        .search {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<h2>Ýüke inwois goşmak</h2>

<div class="container">
    <div>
        <input type="hidden" id="cargoId" th:value="${cargoId}" />
        <input type="text" class="search" placeholder="inwois gözle..." oninput="searchItems()">
        <div class="box" id="items">
            <div th:each="invoice : ${invoices}" th:id="'invoice-' + ${invoice.id}"
                 th:text="${invoice.number}"
                 th:if="${!invoice.selected}" class="item"
                 draggable="true" ondragstart="drag(event)">
            </div>
        </div>
    </div>
    <div class="box" id="dropzone" ondragover="allowDrop(event)" ondrop="drop(event)">
        <div th:each="invoice : ${invoices}" th:id="'invoice-' + ${invoice.id}"
             th:text="${invoice.number}"
             th:if="${invoice.selected}"
             class="item"
             draggable="true" ondragstart="drag(event)">
            <button class="delete-btn" onclick="deleteItem(this, 'invoice-' + [[${invoice.id}]])">X</button>
        </div>
    </div>

</div>

<button onclick="submitSelection()" class="add-drug-btn">Indiki</button>

<script>
    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

function drop(event) {
    event.preventDefault();
    let itemId = event.dataTransfer.getData("text"); // Get dragged item's ID
    let draggedItem = document.getElementById(itemId); // Find the dragged item
    let dropzone = document.getElementById("dropzone"); // Ensure correct target

    if (draggedItem) {
        let newItem = document.createElement("div");
        newItem.className = "item";
        newItem.id = itemId;  // ✅ Keep original ID
        newItem.draggable = true;
        newItem.ondragstart = drag;
        newItem.innerHTML = `${draggedItem.innerText} <button class='delete-btn' onclick='deleteItem(this, "${itemId}")'>X</button>`;

        dropzone.appendChild(newItem); // ✅ Append to dropzone, not another item
        draggedItem.remove();
    }
}



    function deleteItem(button, itemId) {
        let itemText = button.parentElement.innerText.replace("X", "").trim();
        button.parentElement.remove();

        let restoredItem = document.createElement("div");
        restoredItem.className = "item";
        restoredItem.id = itemId;
        restoredItem.draggable = true;
        restoredItem.ondragstart = drag;
        restoredItem.innerText = itemText;

        document.getElementById("items").appendChild(restoredItem);
    }

    function searchItems() {
        let input = document.querySelector(".search").value.toLowerCase();
        let items = document.querySelectorAll("#items .item");

        items.forEach(item => {
            if (item.innerText.toLowerCase().includes(input)) {
                item.style.display = "block";
            } else {
                item.style.display = "none";
            }
        });
    }

function submitSelection() {
    let selectedItems = document.querySelectorAll("#dropzone .item");

    let selectedIds = Array.from(selectedItems).map(item => {
        return Number(item.id.replace("invoice-", ""));
    });


    const cargoId = document.getElementById("cargoId")?.value;

    fetch("/cargos/submit?cargoId="+cargoId, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(selectedIds)
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;  // ✅ Manually redirect
        }
    })
    .catch(error => console.error("Error:", error));
}




</script>

</body>
</html>
